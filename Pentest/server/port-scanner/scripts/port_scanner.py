#!/usr/bin/env python3
import nmap
import json
from flask import Flask, request, jsonify
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

def scan_ports(host, start_port, end_port):
    nm = nmap.PortScanner()
    try:
        result = nm.scan(
            host, 
            f'{start_port}-{end_port}', 
            arguments='-sS -sV -n -Pn --version-intensity 5'
        )
        
        if host in result['scan']:
            ports = result['scan'][host].get('tcp', {})
            open_ports = []
            
            for port, info in ports.items():
                if info['state'] == 'open':
                    open_ports.append({
                        'port': port,
                        'status': 'open',
                        'service': info.get('name', 'unknown'),
                        'version': info.get('version', ''),
                        'product': info.get('product', '')
                    })
            
            return {
                'host': host,
                'open_ports': open_ports,
                'total': len(open_ports)
            }
    except Exception as e:
        return {'error': str(e)}

@app.route('/api/scan-range', methods=['POST'])
def scan_range():
    data = request.json
    host = data.get('host')
    start_port = data.get('startPort')
    end_port = data.get('endPort')
    
    if not all([host, start_port, end_port]):
        return jsonify({'error': 'Missing required parameters'}), 400
    
    result = scan_ports(host, start_port, end_port)
    return jsonify(result)

if __name__ == '__main__':
    print("Iniciando servidor de escaneo de puertos en puerto 3002...")
    app.run(port=3002)
